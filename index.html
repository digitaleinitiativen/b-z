<html>
	<head>
		<title>B Z</title>
	</head>

	<body>
		<label for="story">Text</label><br />
		<textarea id="textarea-plain" rows="5" cols="33">Digitale Initiativen</textarea><br />
		<label for="story">Decode</label><br />
		<textarea id="textarea-encoded" rows="5" cols="33">Digitale Initiativen</textarea><br />
		<br />
		<button onclick="playAudio()">Play</button>
		<button onclick="stopAudio()">Stop</button>
		<script>
			let decode, encode;

			const getJsonFromUrl = async (url) => {
				return (await fetch(url)).json();
			};

			const addChangeListenerToTextarea = (element, onChange) => {
				element.addEventListener("change", onChange);
				element.addEventListener("input", onChange);
				element.addEventListener("keyup", onChange);
			};

			const plainTextarea = document.getElementById("textarea-plain");
			const encodedTextarea = document.getElementById("textarea-encoded");

			const init = async () => {
				const graph = await getJsonFromUrl("./graph.json");
				decode = decodeGenerator(graph);
				encode = encodeGenerator(graph);
				console.log(graph);
				encodedTextarea.value = encode(plainTextarea.value);
			};

			addChangeListenerToTextarea(plainTextarea, () => {
				encodedTextarea.value = encode(plainTextarea.value);
			});

			addChangeListenerToTextarea(encodedTextarea, () => {
				plainTextarea.value = decode(encodedTextarea.value);
			});

			init();

			const timeouts = [];
			const soundMapping = {
				" ": undefined,
				b: () => new Audio("./sounds/b-1.m4a"),
				z: () => new Audio("./sounds/z-1.m4a"),
			};
			const timeMapping = {
				" ": 500,
				b: 200,
				z: 250,
			};

			const playAudio = () => {
				const encoded = encodedTextarea.value;
				let timeOffset = 0;
				for (const letter of encoded.split("")) {
					if ([" ", "b", "z"].includes(letter)) {
						const timeoutId = setTimeout(() => {
							if (soundMapping[letter]) {
								soundMapping[letter]().play();
							}
						}, timeOffset);
						timeouts.push(timeoutId);
						timeOffset += timeMapping[letter];
					}
				}
			};

			const stopAudio = () => {
				for (const timeoutId of timeouts) {
					clearTimeout(timeoutId);
				}
			};
		</script>
		<script src="./huffman-coding.js"></script>
	</body>
</html>
